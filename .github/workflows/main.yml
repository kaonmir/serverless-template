name: AWS lambda unit test
on: 
  push: 
    branches: [ develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  build:
    name: Unit test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Cache NPM dependencies
      uses: actions/cache@v1
      with:
        path: ~/.npm
        key: ${{ runner.OS }}-npm-cache-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-npm-cache-

    - run: npm install

    - name: Unit test
      run: npm run test
    
    # - name: echo if success
    #   if: success()
    #   run: echo "I success the code!"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    if: success()
    steps: 
      - uses: actions/checkout@v1
      - uses: actions/setup-node@v1
        with:
          node-version: '12.x'
      
      - name: Cache NPM dependencies
        uses: actions/cache@v1
        with:
          path: ~/.npm
          key: ${{ runner.OS }}-npm-cache-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.OS }}-npm-cache-

      - name: install dependencies
        run: npm install
        
      - name: install serverless globally
        run: npm install -g serverless
            
      - name: connect to AWS lambda
        run: serverless config credentials -o --provider aws --key ${{secrets.AWS_CREDENTIAL_KEY}} --secret ${{secrets.AWS_CREDENTIAL_SECRET}}

      - name: deploy to AWS lambda
        run: serverless deploy
        
